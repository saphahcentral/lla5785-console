<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Members Management</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { font-family: Arial, sans-serif; margin: 0; background: #eef6ff; }
  header { padding: 10px; background: #004080; color: white; }
  .container { display: flex; gap: 20px; padding: 20px; }
  .table-container { flex: 3; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 5px rgba(0,0,0,0.2);}
  .console-container { flex: 1; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
  table { width: 100%; border-collapse: collapse; }
  th, td { border-bottom: 1px solid #ddd; padding: 8px; text-align: left; }
  button { padding: 6px 12px; margin: 2px; cursor: pointer; border: none; border-radius: 4px; }
  .add-btn { background: #28a745; color: white; margin-bottom: 10px; }
  .edit-btn { background: #ffc107; }
  .delete-btn { background: #dc3545; color: white; }
  /* Modal Styles */
  .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
           background: rgba(0,0,0,0.4); justify-content: center; align-items: center; }
  .modal-content { background: white; padding: 20px; border-radius: 8px; width: 400px; max-width: 90%; }
  .modal-content input, .modal-content select { width: 100%; padding: 8px; margin: 6px 0; }
  .modal-content .close { float: right; cursor: pointer; }
</style>
</head>
<body>

<header>
  <h1>Members Management</h1>
</header>

<div class="container">
  <!-- Main Table -->
  <div class="table-container">
    <button id="addMember" class="add-btn">‚ûï Add Member</button>
    <table id="membersTable">
      <thead>
        <tr><th>Email Address</th><th>Actions</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Console -->
  <div class="console-container">
    <h3>Console</h3>
    <pre id="consoleLog"></pre>
  </div>
</div>

<!-- Modal Form -->
<div id="memberModal" class="modal">
  <div class="modal-content">
    <span id="closeModal" class="close">‚úñ</span>
    <h3 id="modalTitle">Add Member</h3>
    <form id="memberForm">
      <input type="hidden" id="recordId">
      <label>Email:</label>
      <input type="email" id="email" required>
      <label>User ID:</label>
      <input type="text" id="userId" required>
      <label>Name:</label>
      <input type="text" id="name" required>
      <label>Address:</label>
      <input type="text" id="address" required>
      <label>Status:</label>
      <select id="status" required>
        <option value="PENDING">PENDING</option>
        <option value="APPROVED">APPROVED</option>
      </select>
      <label>Upgrade Level:</label>
      <select id="upgradeLevel" required>
        <option value="FREE">FREE</option>
        <option value="VIP">VIP</option>
        <option value="UPGRADED">UPGRADED</option>
        <option value="ADMIN">ADMIN</option>
      </select>
      <label>Date Stamp:</label>
      <input type="date" id="dateStamp" required>
      <label>Upgrade Date:</label>
      <input type="date" id="upgradeDate" required>
      <button type="submit" class="add-btn">‚úÖ Commit</button>
    </form>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, where } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBBn8RmuXVvkbbBB0IquYr9S6hXhIgrQCQ",
  authDomain: "lla5785v3-0.firebaseapp.com",
  projectId: "lla5785v3-0",
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const membersTable = document.querySelector("#membersTable tbody");
const consoleLog = document.getElementById("consoleLog");
const memberModal = document.getElementById("memberModal");
const closeModal = document.getElementById("closeModal");
const memberForm = document.getElementById("memberForm");
const modalTitle = document.getElementById("modalTitle");

let editingId = null;

function log(msg) {
  consoleLog.textContent += msg + "\n";
}

// Load members
async function loadMembers() {
  membersTable.innerHTML = "";
  const snapshot = await getDocs(collection(db, "members"));
  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${data.email || ""}</td>
      <td>
        <button class="edit-btn" data-id="${docSnap.id}">‚úèÔ∏è</button>
        <button class="delete-btn" data-id="${docSnap.id}">üóëÔ∏è</button>
      </td>
    `;
    membersTable.appendChild(tr);
  });
}
loadMembers();

// Open modal
document.getElementById("addMember").addEventListener("click", () => {
  editingId = null;
  modalTitle.textContent = "Add Member";
  memberForm.reset();
  document.getElementById("dateStamp").value = new Date().toISOString().split("T")[0];
  memberModal.style.display = "flex";
});

membersTable.addEventListener("click", async (e) => {
  if (e.target.classList.contains("edit-btn")) {
    editingId = e.target.dataset.id;
    const docSnap = await getDocs(query(collection(db, "members"), where("__name__", "==", editingId)));
    docSnap.forEach(d => {
      const m = d.data();
      document.getElementById("email").value = m.email;
      document.getElementById("userId").value = m.userId;
      document.getElementById("name").value = m.name;
      document.getElementById("address").value = m.address;
      document.getElementById("status").value = m.status;
      document.getElementById("upgradeLevel").value = m.upgradeLevel;
      document.getElementById("dateStamp").value = m.dateStamp;
      document.getElementById("upgradeDate").value = m.upgradeDate;
    });
    modalTitle.textContent = "Edit Member";
    memberModal.style.display = "flex";
  }
  if (e.target.classList.contains("delete-btn")) {
    await deleteDoc(doc(db, "members", e.target.dataset.id));
    log("Deleted member ID: " + e.target.dataset.id);
    loadMembers();
  }
});

// Commit ADD/EDIT
memberForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const data = {
    email: document.getElementById("email").value.trim(),
    userId: document.getElementById("userId").value.trim(),
    name: document.getElementById("name").value.trim(),
    address: document.getElementById("address").value.trim(),
    status: document.getElementById("status").value,
    upgradeLevel: document.getElementById("upgradeLevel").value,
    dateStamp: document.getElementById("dateStamp").value,
    upgradeDate: document.getElementById("upgradeDate").value
  };

  // Validation: upgradeDate > dateStamp
  if (new Date(data.upgradeDate) <= new Date(data.dateStamp)) {
    alert("Upgrade date must be after creation date");
    return;
  }

  if (editingId) {
    await updateDoc(doc(db, "members", editingId), data);
    log("Updated member: " + editingId);
  } else {
    await addDoc(collection(db, "members"), data);
    log("Added member: " + data.email);
  }
  memberModal.style.display = "none";
  loadMembers();
});

closeModal.addEventListener("click", () => {
  memberModal.style.display = "none";
});
</script>
</body>
</html>
