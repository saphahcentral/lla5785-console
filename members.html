<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>LLA5785 Members Console</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { font-family: Arial, sans-serif; background: #f9f9f9; margin: 0; padding: 20px; display: flex; }
  .container { flex: 1; max-width: 800px; }
  h1 { color: #003366; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
  th { background-color: #eee; }
  button { padding: 6px 12px; margin: 2px; }
  #console { width: 300px; margin-left: 20px; white-space: pre-wrap; background: #111; color: #0f0; padding: 10px; overflow-y: auto; border-radius: 4px; max-height: 90vh; }
  #authStatus { font-weight: bold; margin-top: 8px; }
  /* Modal styles */
  .modal { display: none; position: fixed; z-index: 10; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background: rgba(0,0,0,0.5); }
  .modal-content { background: #fff; margin: 50px auto; padding: 20px; border-radius: 8px; max-width: 800px; max-height: 80vh; overflow-y: auto; display: flex; flex-wrap: wrap; }
  .modal-column { flex: 1 1 50%; box-sizing: border-box; padding: 5px; }
  .modal-column label { display: block; margin-top: 10px; font-weight: bold; }
  .modal-column input { width: 95%; padding: 5px; margin-top: 2px; }
  .modal-buttons { text-align: right; width: 100%; margin-top: 15px; }
</style>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="container">
    <h1>LLA5785 Members Console</h1>
    <div id="authStatus">Checking authentication...</div>
    <button id="addMemberBtn">➕ Add Member</button>

    <table id="membersTable">
      <thead>
        <tr>
          <th>Email</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <pre id="console">Console log:</pre>

  <!-- Modal -->
  <div id="memberModal" class="modal">
    <div class="modal-content">
      <!-- Left column -->
      <div class="modal-column">
        <label>Email</label><input type="text" id="email">
        <label>Status</label><input type="text" id="status">
        <label>Upgrade Level</label><input type="text" id="upgradeLevel">
        <label>Upgrade Date</label><input type="text" id="upgradeDate">
        <label>Timestamp</label><input type="text" id="timestamp">
        <label>UserID</label><input type="text" id="userID">
      </div>
      <!-- Right column -->
      <div class="modal-column">
        <label>First Name</label><input type="text" id="firstName">
        <label>Last Name</label><input type="text" id="lastName">
        <label>Business Name</label><input type="text" id="businessName">
        <label>Phone Number</label><input type="text" id="phoneNumber">
        <label>Business Address</label><input type="text" id="businessAddress">
        <label>Referrer</label><input type="text" id="referrer">
        <label>Testimonial</label><input type="text" id="testimonial">
        <label>Testimonial Date</label><input type="text" id="testimonialDate">
      </div>
      <div class="modal-buttons">
        <button id="commitBtn">💾 Commit</button>
        <button id="cancelBtn">✖ Cancel</button>
      </div>
    </div>
  </div>

<script>
const ADMIN_EMAIL = "bessingerbackup2024@gmail.com";
const firebaseConfig = {
  apiKey: "AIzaSyBBn8RmuXVvkbbBB0IquYr9S6hXhIgrQCQ",
  authDomain: "lla5785v3-0.firebaseapp.com",
  projectId: "lla5785v3-0"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
const logEl = document.getElementById("console");
const authStatusEl = document.getElementById("authStatus");

function log(msg) {
  const ts = new Date().toISOString();
  logEl.textContent += `\n[${ts}] ${msg}`;
  logEl.scrollTop = logEl.scrollHeight;
  console.log(msg);
}

let currentDocId = null;

async function loadMembers() {
  const tbody = document.querySelector("#membersTable tbody");
  tbody.innerHTML = "";
  try {
    const snapshot = await db.collection("members").get();
    if (snapshot.empty) { log("⚠️ No members found."); return; }
    snapshot.forEach(doc => {
      const data = doc.data();
      const row = tbody.insertRow();
      row.insertCell().textContent = data.email || "(no email)";
      const actionsCell = row.insertCell();

      const editBtn = document.createElement("button");
      editBtn.textContent = "Edit";
      editBtn.onclick = () => openModal(doc.id, data);
      actionsCell.appendChild(editBtn);

      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "Delete";
      deleteBtn.onclick = async () => {
        if(!confirm(`Delete ${data.email}?`)) return;
        try {
          await db.collection("members").doc(doc.id).delete();
          log(`Deleted: ${data.email}`);
          await loadMembers();
        } catch(e) { log("Delete error: " + e.message); }
      };
      actionsCell.appendChild(deleteBtn);
    });
    log(`✅ Members loaded: ${snapshot.size}`);
  } catch(e) { log("Error loading members: " + e.message); }
}

function openModal(docId=null, data={}) {
  currentDocId = docId;
  const fields = ["email","status","upgradeLevel","upgradeDate","timestamp","userID","firstName","lastName","businessName","phoneNumber","businessAddress","referrer","testimonial","testimonialDate"];
  fields.forEach(f => document.getElementById(f).value = data[f] || "");
  document.getElementById("memberModal").style.display = "block";
}

document.getElementById("addMemberBtn").addEventListener("click", () => openModal());

document.getElementById("cancelBtn").addEventListener("click", () => {
  document.getElementById("memberModal").style.display = "none";
});

document.getElementById("commitBtn").addEventListener("click", async () => {
  const memberData = {};
  const fields = ["email","status","upgradeLevel","upgradeDate","timestamp","userID","firstName","lastName","businessName","phoneNumber","businessAddress","referrer","testimonial","testimonialDate"];
  fields.forEach(f => memberData[f] = document.getElementById(f).value.trim());

  // Validation
  if(!memberData.email || !memberData.userID || !memberData.firstName || !memberData.lastName || !memberData.businessAddress) {
    alert("Email, UserID, First Name, Last Name and Business Address are required.");
    return;
  }
  if(!["APPROVED","PENDING","ADMIN"].includes(memberData.status.toUpperCase())) {
    alert("Status must be APPROVED, PENDING or ADMIN.");
    return;
  }
  if(!["ADMIN","UPGRADED","FREE","VIP"].includes(memberData.upgradeLevel.toUpperCase())) {
    alert("Upgrade Level must be ADMIN, UPGRADED, FREE, or VIP.");
    return;
  }
  // Add/Update
  try {
    if(currentDocId) {
      await db.collection("members").doc(currentDocId).update(memberData);
      log(`Updated: ${memberData.email}`);
    } else {
      const newDoc = await db.collection("members").add(memberData);
      log(`Added: ${memberData.email} (ID: ${newDoc.id})`);
    }
    document.getElementById("memberModal").style.display = "none";
    await loadMembers();
  } catch(e) {
    log("Commit error: " + e.message);
  }
});

// Auth
auth.onAuthStateChanged(async (user) => {
  if(user && (user.email||"").toLowerCase()===ADMIN_EMAIL.toLowerCase()) {
    authStatusEl.textContent = `Authenticated as admin: ${user.email}`;
    await loadMembers();
  } else {
    authStatusEl.textContent = "Access denied: not admin.";
    log("Access denied.");
  }
});
</script>
</body>
</html>
