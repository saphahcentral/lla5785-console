<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>LLA5785 Members Console</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: Arial, sans-serif; display:flex; margin:0; background:#f4f4f4; }
.table-container { flex:1; padding:20px; }
table { width:100%; border-collapse: collapse; margin-top:10px; }
th, td { border:1px solid #ccc; padding:8px; text-align:left; }
th { background:#eee; }
button { padding:4px 8px; margin-right:4px; }
#console { width:300px; background:#111; color:#0f0; padding:10px; overflow-y:auto; white-space:pre-wrap; height:100vh; }
#authStatus { font-weight:bold; margin-bottom:10px; }
#addMember { margin-bottom:10px; padding:6px 12px; }
.modal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
       background:white; padding:20px; border:1px solid #ccc; border-radius:6px; z-index:1000; max-width:500px; width:90%; }
.modal label { display:block; margin-top:8px; font-weight:bold; }
.modal input { width:100%; padding:4px; margin-top:2px; }
.modal button { margin-top:10px; }
.overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999; }
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
<div class="table-container">
<h1>Members Database</h1>
<div id="authStatus">Checking authentication...</div>
<button id="addMember">➕ Add Member</button>
<table id="membersTable">
<thead><tr><th>Email</th><th>Actions</th></tr></thead>
<tbody></tbody>
</table>
</div>

<pre id="console">Console log:</pre>

<div class="overlay" id="overlay"></div>
<div class="modal" id="memberModal">
<h3 id="modalTitle">Edit Member</h3>
<label>Unique ID<input type="text" id="field_uniqueID" readonly></label>
<label>Email<input type="text" id="field_email"></label>
<label>Status<input type="text" id="field_status"></label>
<label>Testimonial<input type="text" id="field_testimonial"></label>
<label>Testimonial Date<input type="text" id="field_testimonialDate"></label>
<label>Timestamp<input type="text" id="field_timestamp"></label>
<label>Upgrade Date<input type="text" id="field_upgradeDate"></label>
<label>Upgrade Level<input type="text" id="field_upgradeLevel"></label>
<label>User ID<input type="text" id="field_userID"></label>
<button id="commitMember">✅ Commit</button>
<button id="cancelMember">❌ Cancel</button>
</div>

<script>
const ADMIN_EMAIL = "bessingerbackup2024@gmail.com";
const firebaseConfig = {
  apiKey: "AIzaSyBBn8RmuXVvkbbBB0IquYr9S6hXhIgrQCQ",
  authDomain: "lla5785v3-0.firebaseapp.com",
  projectId: "lla5785v3-0"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
const logEl = document.getElementById("console");
const authStatusEl = document.getElementById("authStatus");
const tableBody = document.querySelector("#membersTable tbody");
let editingDocId = null;

function log(msg){
  const ts = new Date().toISOString();
  logEl.textContent += `\n[${ts}] ${msg}`;
  logEl.scrollTop = logEl.scrollHeight;
}

async function loadMembers(){
  tableBody.innerHTML = "";
  try{
    const snapshot = await db.collection("members").get();
    if(snapshot.empty){ log("⚠️ No members found."); return; }
    snapshot.forEach(doc=>{
      const data = doc.data();
      const row = tableBody.insertRow();
      row.insertCell().textContent = data.email || "(no email)";
      const actionsCell = row.insertCell();
      const editBtn = document.createElement("button");
      editBtn.textContent="Edit";
      editBtn.onclick=()=>openModal(doc.id,data);
      const deleteBtn = document.createElement("button");
      deleteBtn.textContent="Delete";
      deleteBtn.onclick=async()=>{
        if(!confirm(`Delete ${data.email}?`)) return;
        await db.collection("members").doc(doc.id).delete();
        log(`Deleted ${data.email}`);
        loadMembers();
      };
      actionsCell.appendChild(editBtn);
      actionsCell.appendChild(deleteBtn);
    });
    log(`Loaded ${snapshot.size} member(s).`);
  } catch(e){ log("❌ Error loading members: "+e.message); }
}

function openModal(docId=null,data=null){
  editingDocId=docId;
  document.getElementById("overlay").style.display="block";
  const modal = document.getElementById("memberModal");
  modal.style.display="block";
  document.getElementById("modalTitle").textContent = docId?"Edit Member":"Add Member";
  document.getElementById("field_uniqueID").value = data?.uniqueID || (docId?docId:"");
  document.getElementById("field_email").value = data?.email||"";
  document.getElementById("field_status").value = data?.status||"";
  document.getElementById("field_testimonial").value = data?.testimonial||"";
  document.getElementById("field_testimonialDate").value = data?.testimonialDate||"";
  document.getElementById("field_timestamp").value = data?.timestamp||"";
  document.getElementById("field_upgradeDate").value = data?.upgradeDate||"";
  document.getElementById("field_upgradeLevel").value = data?.upgradeLevel||"";
  document.getElementById("field_userID").value = data?.userID||"";
}

function closeModal(){ editingDocId=null; document.getElementById("overlay").style.display="none"; document.getElementById("memberModal").style.display="none"; }

document.getElementById("commitMember").onclick=async()=>{
  const data={
    uniqueID: document.getElementById("field_uniqueID").value,
    email: document.getElementById("field_email").value.trim(),
    status: document.getElementById("field_status").value.trim(),
    testimonial: document.getElementById("field_testimonial").value.trim(),
    testimonialDate: document.getElementById("field_testimonialDate").value.trim(),
    timestamp: document.getElementById("field_timestamp").value.trim(),
    upgradeDate: document.getElementById("field_upgradeDate").value.trim(),
    upgradeLevel: document.getElementById("field_upgradeLevel").value.trim(),
    userID: document.getElementById("field_userID").value.trim()
  };

  // Validation
  if(!data.email || !data.userID){ alert("Email and User ID required"); return; }
  if(!["APPROVED","PENDING"].includes(data.status.toUpperCase())){ alert("Status must be APPROVED or PENDING"); return; }
  if(!["ADMIN","UPGRADED","FREE","VIP"].includes(data.upgradeLevel.toUpperCase())){ alert("Upgrade Level invalid"); return; }
  if(data.upgradeDate<data.timestamp){ alert("Upgrade Date cannot be before Timestamp"); return; }

  try{
    // Check uniqueness of email/userID for new record
    const allMembers = await db.collection("members").get();
    if(!editingDocId){
      if(allMembers.docs.some(doc=>doc.data().email===data.email)){ alert("Email already exists"); return; }
      if(allMembers.docs.some(doc=>doc.data().userID===data.userID)){ alert("User ID already exists"); return; }
      const newDoc=db.collection("members").doc();
      data.uniqueID=newDoc.id;
      await newDoc.set(data);
      log(`Added member ${data.email}`);
    } else {
      const docRef = db.collection("members").doc(editingDocId);
      await docRef.set(data,{merge:true});
      log(`Updated member ${data.email}`);
    }
    closeModal();
    loadMembers();
  } catch(e){ log("❌ Commit error: "+e.message); }
};

document.getElementById("cancelMember").onclick=closeModal;
document.getElementById("addMember").onclick=()=>openModal(null,null);

auth.onAuthStateChanged(user=>{
  if(user && (user.email||"").toLowerCase()===ADMIN_EMAIL.toLowerCase()){
    authStatusEl.textContent=`Authenticated as admin: ${user.email}`;
    loadMembers();
  } else {
    authStatusEl.textContent="Access denied: not admin";
    log("Access denied");
  }
});
</script>
</body>
</html>
