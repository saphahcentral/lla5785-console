<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>LLA5785 Console - Members</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: Arial, sans-serif; background:#f9f9f9; margin:0; padding:20px; display:flex; }
.container { flex:1; }
#console { width: 350px; white-space: pre-wrap; background:#111; color:#0f0; padding:10px; margin-left:20px; height: 90vh; overflow-y:auto; border-radius:4px;}
table { width:100%; border-collapse: collapse; margin-top:10px; }
th, td { border:1px solid #ccc; padding:6px; text-align:left; }
th { background:#eee; }
button { padding:4px 8px; margin:2px; }
.add-button { margin-bottom:10px; padding:6px 12px; background:#0066cc; color:white; border:none; border-radius:4px; cursor:pointer;}
.add-button:hover { background:#004d99;}
.modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); z-index:1000; }
.modal { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:20px; border-radius:8px; box-shadow:0 0 15px rgba(0,0,0,0.3); max-width:800px; max-height:90vh; overflow-y:auto; z-index:1001; }
.modal-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.modal button { margin-top:10px; }
#authStatus { font-weight:bold; margin-top:8px; }
</style>
<!-- Firebase App & Firestore & Auth (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
<div class="container">
<h1>LLA5785 Console - Members</h1>
<div id="authStatus">Checking authentication...</div>
<button id="addMemberBtn" class="add-button">➕ Add Member</button>
<table id="membersTable">
<thead>
<tr>
<th>Email</th>
<th>Actions</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<pre id="console">Console log:</pre>

<!-- Modal -->
<div id="modalOverlay" class="modal-overlay">
  <div class="modal">
    <h2 id="modalTitle">Add/Edit Member</h2>
    <div class="modal-grid">
      <input type="text" id="firstName" placeholder="First Name">
      <input type="text" id="lastName" placeholder="Last Name">
      <input type="text" id="businessName" placeholder="Business Name">
      <input type="text" id="phoneNumber" placeholder="Phone Number">
      <input type="text" id="businessAddress" placeholder="Business Address">
      <input type="text" id="email" placeholder="Email">
      <input type="text" id="userID" placeholder="User ID">
      <input type="text" id="status" placeholder="Status (APPROVED/PENDING/ADMIN)">
      <input type="text" id="upgradeLevel" placeholder="Upgrade Level (ADMIN/UPGRADED/FREE/VIP)">
      <input type="text" id="timestamp" placeholder="Date Stamp (YYYY-MM-DD)">
      <input type="text" id="upgradeDate" placeholder="Upgrade Date (YYYY-MM-DD)">
      <input type="text" id="referrer" placeholder="Referrer">
      <input type="text" id="testimonial" placeholder="Testimonial">
      <input type="text" id="testimonialDate" placeholder="Testimonial Date (YYYY-MM-DD)">
    </div>
    <button id="commitBtn">Commit</button>
    <button id="closeModalBtn">Cancel</button>
  </div>
</div>

<script>
const ADMIN_EMAIL = "bessingerbackup2024@gmail.com";
const firebaseConfig = {
  apiKey:"AIzaSyBBn8RmuXVvkbbBB0IquYr9S6hXhIgrQCQ",
  authDomain:"lla5785v3-0.firebaseapp.com",
  projectId:"lla5785v3-0",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
const logEl = document.getElementById("console");
const authStatusEl = document.getElementById("authStatus");
const tableBody = document.querySelector("#membersTable tbody");
function log(msg){ const ts=new Date().toISOString(); logEl.textContent+=`\n[${ts}] ${msg}`; logEl.scrollTop=logEl.scrollHeight; console.log(msg); }

let editDocId=null;

// Open modal
const modalOverlay=document.getElementById("modalOverlay");
document.getElementById("addMemberBtn").addEventListener("click",()=>{
  editDocId=null;
  document.getElementById("modalTitle").textContent="Add Member";
  document.querySelectorAll(".modal input").forEach(i=>i.value="");
  modalOverlay.style.display="block";
});
document.getElementById("closeModalBtn").addEventListener("click",()=>{modalOverlay.style.display="none";});

// Load members
async function loadMembers(){
  tableBody.innerHTML="";
  const snapshot = await db.collection("members").get();
  snapshot.forEach(doc=>{
    const data=doc.data();
    const row=tableBody.insertRow();
    row.insertCell().textContent=data.email||"(no email)";
    const actions=row.insertCell();
    const editBtn=document.createElement("button");
    editBtn.textContent="Edit";
    editBtn.onclick=()=>openEdit(doc.id,data);
    const deleteBtn=document.createElement("button");
    deleteBtn.textContent="Delete";
    deleteBtn.onclick=async()=>{
      if(!confirm(`Delete ${data.email || doc.id}?`)) return;
      await db.collection("members").doc(doc.id).delete();
      log(`Deleted: ${data.email || doc.id}`);
      await loadMembers();
    };
    actions.appendChild(editBtn);
    actions.appendChild(deleteBtn);
  });
  log(`Loaded ${snapshot.size} member(s).`);
}

// Open edit modal
function openEdit(docId,data){
  editDocId=docId;
  document.getElementById("modalTitle").textContent="Edit Member";
  const fields=["firstName","lastName","businessName","phoneNumber","businessAddress","email","userID","status","upgradeLevel","timestamp","upgradeDate","referrer","testimonial","testimonialDate"];
  fields.forEach(f=>{
    document.getElementById(f).value=data[f]||"";
  });
  modalOverlay.style.display="block";
}

// Commit changes
document.getElementById("commitBtn").addEventListener("click",async()=>{
  const fields=["firstName","lastName","businessName","phoneNumber","businessAddress","email","userID","status","upgradeLevel","timestamp","upgradeDate","referrer","testimonial","testimonialDate"];
  const newData={};
  for(const f of fields){ newData[f]=document.getElementById(f).value.trim(); }
  // Validation
  if(!newData.firstName||!newData.lastName||!newData.businessAddress||!newData.email||!newData.userID){ alert("FirstName, LastName, BusinessAddress, Email, and UserID are required."); return; }
  if(!["APPROVED","PENDING","ADMIN"].includes(newData.status)){ alert("Status must be APPROVED, PENDING, or ADMIN."); return; }
  if(!["ADMIN","UPGRADED","FREE","VIP"].includes(newData.upgradeLevel)){ alert("UpgradeLevel must be ADMIN, UPGRADED, FREE, or VIP."); return; }
  if(newData.upgradeDate && newData.timestamp && new Date(newData.upgradeDate)<new Date(newData.timestamp)){ alert("UpgradeDate must be >= timestamp."); return; }
  try{
    if(editDocId){
      await db.collection("members").doc(editDocId).update(newData);
      log(`Updated member: ${newData.email}`);
    }else{
      // Check for unique email/userID
      const emailCheck=await db.collection("members").where("email","==",newData.email).get();
      if(!emailCheck.empty){ alert("Email already exists."); return; }
      const userIDCheck=await db.collection("members").where("userID","==",newData.userID).get();
      if(!userIDCheck.empty){ alert("userID already exists."); return; }
      await db.collection("members").add(newData);
      log(`Added member: ${newData.email}`);
    }
    modalOverlay.style.display="none";
    await loadMembers();
  }catch(e){ log("❌ Error: "+e.message); }
});

// Auth
auth.onAuthStateChanged(user=>{
  if(user && user.email===ADMIN_EMAIL){
    authStatusEl.textContent=`Authenticated as admin: ${user.email}`;
    loadMembers();
  }else{
    authStatusEl.textContent="Access denied: You are not authenticated as admin.";
    log("Access denied: non-admin or not signed in.");
  }
});
</script>
</body>
</html>
