<!DOCTYPE html>
<html>
<head>
  <title>Data Propagation</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
    import { getFirestore, collection, setDoc, doc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBBn8RmuXVvkbbBB0IquYr9S6hXhIgrQCQ",
      authDomain: "lla5785v3-0.firebaseapp.com",
      projectId: "lla5785v3-0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const csvUrls = {
      members: "https://docs.google.com/spreadsheets/d/e/2PACX-1vT5PjdqsQRoFjWhKHpisSFvaeVqkFBn6AO37n_EeD9ncva0QF3MO0xFyuMqAtr0DyvTbzzNN-7YrdG_/pub?output=csv",
      ads: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRSn8y-d5UpR717rDlx6f0t3YO7iadHLCCDgACgU8xKqc6RLdlC2qWXFtqrqYf5Q3elboqgExIIGfo-/pub?output=csv",
      testimonials: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTT2zrm8O3gf1G_LqqUL75XZ25rxzs9GpiBMQoOYaphqLliloHvGIeoZIO6tKE56EzZyo2xBnUKis39/pub?output=csv"
    };

    async function fetchCSV(url) {
      const res = await fetch(url);
      const text = await res.text();
      const [headerLine, ...lines] = text.trim().split('\n');
      const headers = headerLine.split(',');
      return lines.map(line => {
        const data = {};
        line.split(',').forEach((val, i) => data[headers[i]] = val);
        return data;
      });
    }

    async function propagateData() {
      const members = await fetchCSV(csvUrls.members);
      const ads = await fetchCSV(csvUrls.ads);
      const testimonials = await fetchCSV(csvUrls.testimonials);

      // Store members
      for (const member of members) {
        const email = member["Email Address"]?.toLowerCase();
        if (!email) continue;
        await setDoc(doc(db, "members", email), member);
      }

      // Store ads
      for (const ad of ads) {
        await setDoc(doc(collection(db, "ad_list")), ad);
      }

      // Update testimonials in members by matching email
      for (const t of testimonials) {
        const email = t["Email Address"]?.toLowerCase();
        if (!email) continue;
        const memberRef = doc(db, "members", email);
        await setDoc(memberRef, { testimonial: t["Testimonial"] }, { merge: true });
      }

      console.log("Data propagation complete.");
    }

    propagateData().catch(console.error);
  </script>
</head>
<body>
  <h1>Propagating Data to Firestore...</h1>
</body>
</html>
