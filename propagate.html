<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Propagate Database</title>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore-compat.js"></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <style>
    body { font-family: monospace; padding: 20px; background: #f4f4f4; }
    pre { background: white; padding: 10px; border: 1px solid #ccc; height: 600px; overflow: auto; }
    button { padding: 10px 20px; font-size: 16px; }
  </style>
</head>
<body>
  <h2>Propagate Data from Google Sheets</h2>
  <button onclick="startPropagation()">Start Propagation</button>
  <pre id="log"></pre>

  <script>
    const log = msg => document.getElementById("log").textContent += msg + "\n";

    const firebaseConfig = {
      apiKey: "AIzaSyBBn8RmuXVvkbbBB0IquYr9S6hXhIgrQCQ",
      authDomain: "lla5785v3-0.firebaseapp.com",
      projectId: "lla5785v3-0",
      storageBucket: "lla5785v3-0.firebasestorage.app",
      messagingSenderId: "730972554331",
      appId: "1:730972554331:web:d97a5fbacebd6aa6e32b7e",
      measurementId: "G-WZNQ24S4DM"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const CLIENT_ID = '730972554331-vlbe1ifgjc5lcmntn66evk2r1qt3la13.apps.googleusercontent.com';
    const API_KEY = firebaseConfig.apiKey;
    const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
    const SCOPES = "https://www.googleapis.com/auth/spreadsheets.readonly";

    const SPREADSHEET_ID = '1smzwrYHFMEQFLz28ydXL9xFgKuGqkRu6lyVWlKlqY1M';
    const SHEETS = ["members1", "members2", "ads1", "ads2"];

    function startPropagation() {
      gapi.load('client:auth2', async () => {
        await gapi.client.init({ apiKey: API_KEY, clientId: CLIENT_ID, discoveryDocs: DISCOVERY_DOCS, scope: SCOPES });
        try {
          await gapi.auth2.getAuthInstance().signIn();
          log("✔ Signed into Google Sheets\n");
          for (let sheetName of SHEETS) {
            log(`--- Reading sheet: ${sheetName} ---`);
            const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: sheetName });
            const rows = res.result.values;
            if (!rows || rows.length < 2) { log("No data found.\n"); continue; }
            const headers = rows[0];

            for (let i = 1; i < rows.length; i++) {
              const row = rows[i];
              const doc = {};
              headers.forEach((h, idx) => doc[h.trim()] = row[idx]?.trim() || "");

              if (sheetName.startsWith("members")) {
                await addToCollection("members", "email", doc);
              } else if (sheetName.startsWith("ads")) {
                await addToCollection("ad_list", "id", doc);
                if (sheetName === "ads2") await addToCollection("members", "email", doc);
              }
            }
          }
          log("\n✔ All sheets processed.\n");
        } catch (err) {
          log("✘ Error: " + err.message);
        }
      });
    }

    async function addToCollection(collection, uniqueField, data) {
      const snapshot = await db.collection(collection).where(uniqueField, "==", data[uniqueField]).get();
      if (!snapshot.empty) {
        log(`[SKIP] ${collection}: ${data[uniqueField]}`);
        return;
      }
      await db.collection(collection).add(data);
      log(`[ADD]  ${collection}: ${data[uniqueField]}`);
    }
  </script>
</body>
</html>
