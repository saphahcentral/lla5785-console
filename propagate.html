<!DOCTYPE html>
<html>
<head>
  <title>Propagate from Sheets</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body style="font-family: monospace; background: #f0f0f0; padding: 2em;">
  <h2>Propagate from Google Sheets</h2>
  <button id="startBtn">Start Propagation</button>
  <pre id="log" style="background: #000; color: #0f0; padding: 1em; height: 400px; overflow-y: scroll;"></pre>

  <script>
    const log = (msg) => {
      const pre = document.getElementById('log');
      pre.textContent += `>> ${msg}\n`;
      pre.scrollTop = pre.scrollHeight;
    };

    const firebaseConfig = {
      apiKey: "AIzaSyCN-BVqWjHJApKDHElS4JD84zGH0X88Zro",
      authDomain: "lla5785.firebaseapp.com",
      projectId: "lla5785",
      storageBucket: "lla5785.appspot.com",
      messagingSenderId: "1072960696740",
      appId: "1:1072960696740:web:2db4fc613ac5bbd9fe6416"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let gapiInited = false;

    const SHEET_ID = "1oI9FvfnrwON-AIlpxpNuT29l88lrxE25XIn3kGB5CyA";
    const SHEETS = [
      { name: "members1", collection: "members" },
      { name: "members2", collection: "members" },
      { name: "ads1", collection: "ad_list" },
      { name: "ads2", collection: "both" }
    ];

    const initGapi = () => {
      gapi.load('client', async () => {
        await gapi.client.init({
          apiKey: firebaseConfig.apiKey,
          discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"]
        });
        gapiInited = true;
      });
    };

    const getSheetData = async (sheetName) => {
      const res = await gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: SHEET_ID,
        range: `${sheetName}`
      });
      return res.result.values;
    };

    const processSheet = async (sheet) => {
      log(`Reading ${sheet.name}...`);
      const data = await getSheetData(sheet.name);
      if (!data || data.length < 2) return log(`No data in ${sheet.name}`);

      const headers = data[0];
      const rows = data.slice(1);

      for (const row of rows) {
        const obj = {};
        headers.forEach((h, i) => obj[h] = row[i] || "");

        let emailKey = obj.email || obj.uid || obj.title || JSON.stringify(obj);
        let adKey = obj.uid || obj.email || obj.title || JSON.stringify(obj);

        const writeTo = sheet.collection === "both"
          ? ["members", "ad_list"]
          : [sheet.collection];

        for (const col of writeTo) {
          const key = col === "members" ? emailKey : adKey;
          const ref = db.collection(col).doc(key);
          const snap = await ref.get();

          if (snap.exists) {
            log(`Skipped in ${col}: ${key}`);
          } else {
            await ref.set(obj);
            log(`Added to ${col}: ${key}`);
          }
        }
      }

      log(`COMMIT COMPLETE for ${sheet.name}`);
    };

    document.getElementById('startBtn').addEventListener('click', async () => {
      if (!gapiInited) await initGapi();

      auth.onAuthStateChanged(async (user) => {
        if (!user) {
          const provider = new firebase.auth.GoogleAuthProvider();
          provider.setCustomParameters({ prompt: 'select_account' });
          await auth.signInWithPopup(provider);
        }

        for (const sheet of SHEETS) {
          try {
            await processSheet(sheet);
          } catch (err) {
            log(`ERROR processing ${sheet.name}: ${err.message}`);
          }
        }

        log("\nALL SHEETS PROCESSED.");
      });
    });

    initGapi();
  </script>
</body>
</html>
