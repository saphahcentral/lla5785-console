<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Propagate Data to Firebase</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2rem;
      background: #f9f9f9;
      color: #333;
    }
    button {
      padding: 10px 20px;
      font-size: 1rem;
      cursor: pointer;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
    }
    pre {
      margin-top: 20px;
      padding: 15px;
      background: #eee;
      border-radius: 5px;
      height: 300px;
      overflow-y: scroll;
      white-space: pre-wrap;
      font-family: Consolas, monospace;
    }
  </style>
</head>
<body>
  <h1>Propagate Google Sheets Data to Firebase</h1>
  <button id="start-btn">START PROPAGATE</button>
  <pre id="console-log"></pre>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getFirestore,
      collection,
      doc,
      getDoc,
      setDoc
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
    import {
      getAuth,
      signInWithPopup,
      GoogleAuthProvider,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    // Your Firebase config here
    const firebaseConfig = {
      apiKey: "AIzaSyBBn8RmuXVvkbbBB0IquYr9S6hXhIgrQCQ",
      authDomain: "lla5785v3-0.firebaseapp.com",
      projectId: "lla5785v3-0",
      storageBucket: "lla5785v3-0.firebasestorage.app",
      messagingSenderId: "730972554331",
      appId: "1:730972554331:web:d97a5fbacebd6aa6e32b7e",
      measurementId: "G-WZNQ24S4DM"
    };

    const SHEETS = [
      { id: "1cc70DNzSvOw1q67VC3-V9q4Hqy-PDXN65jfMEhsy1Ro", range: "members1", collection: "members" },
      { id: "1caBt8yogXcTQweUfb6iQuPly2RY7Gq_3vF_xGLrEAs0", range: "members2", collection: "members" },
      { id: "1tYmQVy6vDjLGcVkTCbmrwtnzY5cnGrwRSJu48LrhTc8", range: "ads1", collection: "ad_list" },
      { id: "1pi-eqrlLVp_52ZtnkRXv8Qk0mOVoV-AxY5upLfXRTlI", range: "ads2", collection: "ad_list" }
    ];

    const consoleLog = document.getElementById("console-log");
    const startBtn = document.getElementById("start-btn");

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // Helper to log messages
    function log(msg) {
      consoleLog.textContent += msg + "\n";
      consoleLog.scrollTop = consoleLog.scrollHeight;
    }

    // Load Google API client library
    function loadGapiClient() {
      return new Promise((resolve, reject) => {
        gapi.load("client:auth2", async () => {
          try {
            await gapi.client.init({
              apiKey: firebaseConfig.apiKey,
              discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
              clientId: "730972554331-p3vk7jbb4k5grt9vb6ap4is08a2j6uqa.apps.googleusercontent.com",
              scope: "https://www.googleapis.com/auth/spreadsheets.readonly"
            });
            resolve();
          } catch (err) {
            reject(err);
          }
        });
      });
    }

    async function signIn() {
      try {
        await signInWithPopup(auth, provider);
        log("Signed in as " + auth.currentUser.email);
      } catch (err) {
        log("Sign-in failed: " + err.message);
        throw err;
      }
    }

    async function fetchSheetData(sheetId, range) {
      try {
        const response = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: sheetId,
          range: range
        });
        return response.result.values || [];
      } catch (err) {
        throw new Error(`Failed to fetch sheet ${sheetId} range ${range}: ${err.message}`);
      }
    }

    async function addIfNotExists(collectionName, record) {
      if (!record.id) {
        log(`Skipping record without ID in ${collectionName}`);
        return;
      }
      const docRef = doc(db, collectionName, record.id);
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        log(`Skipping existing ${collectionName} ID: ${record.id}`);
        return;
      }
      await setDoc(docRef, record);
      log(`Added new ${collectionName} ID: ${record.id}`);
    }

    function rowToRecord(headers, row) {
      let record = {};
      for (let i = 0; i < headers.length; i++) {
        record[headers[i]] = row[i] || "";
      }
      return record;
    }

    async function propagate() {
      try {
        log("Starting propagation...");
        await loadGapiClient();
        if (!auth.currentUser) {
          await signIn();
        }
        for (const sheet of SHEETS) {
          log(`Reading sheet "${sheet.range}" from ${sheet.id}...`);
          const rows = await fetchSheetData(sheet.id, sheet.range);
          if (rows.length < 2) {
            log(`No data found in ${sheet.range}`);
            continue;
          }
          const headers = rows[0];
          for (let i = 1; i < rows.length; i++) {
            const record = rowToRecord(headers, rows[i]);
            await addIfNotExists(sheet.collection, record);
          }
        }
        log("Propagation complete.");
      } catch (err) {
        log("Error: " + err.message);
      }
    }

    startBtn.addEventListener("click", () => {
      consoleLog.textContent = "";
      propagate();
    });

  </script>

  <script async src="https://apis.google.com/js/api.js"></script>
</body>
</html>
