<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Propagate Console</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
  <h2>LLA5785 Database Propagation</h2>
  <button id="startBtn">START PROPAGATION</button>
  <pre id="log" style="background:#000;color:#0f0;padding:1em;height:600px;overflow:auto;"></pre>

  <script>
    const log = (msg) => {
      const el = document.getElementById('log');
      el.textContent += msg + "\n";
      el.scrollTop = el.scrollHeight;
    };

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBBn8RmuXVvkbbBB0IquYr9S6hXhIgrQCQ",
      authDomain: "lla5785v3-0.firebaseapp.com",
      projectId: "lla5785v3-0",
      storageBucket: "lla5785v3-0.firebasestorage.app",
      messagingSenderId: "730972554331",
      appId: "1:730972554331:web:d97a5fbacebd6aa6e32b7e",
      measurementId: "G-WZNQ24S4DM"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Google API setup
    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets.readonly';
    const DISCOVERY_DOCS = ['https://sheets.googleapis.com/$discovery/rest?version=v4'];
    const SHEET_ID = '1zK5Yy2mnQe2YYGkZkpSNo7yAdn0x8VpMFJ_l_dUtRLU';

    const loadGapi = () => {
      return new Promise((resolve) => {
        gapi.load('client:auth2', async () => {
          await gapi.client.init({
            apiKey: firebaseConfig.apiKey,
            clientId: '730972554331-v0k2biop8qfpmig7km7j6oklqcu9jssk.apps.googleusercontent.com',
            discoveryDocs: DISCOVERY_DOCS,
            scope: SCOPES,
          });
          resolve();
        });
      });
    };

    const getSheet = async (range) => {
      log(`Reading sheet: ${range}`);
      const res = await gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: SHEET_ID,
        range: range,
      });
      return res.result.values;
    };

    const recordExists = async (collection, docId) => {
      const doc = await db.collection(collection).doc(docId).get();
      return doc.exists;
    };

    const upsertRecord = async (collection, docId, data) => {
      await db.collection(collection).doc(docId).set(data);
    };

    const processSheet = async (rows, collection, idField, dualWrite = false) => {
      const headers = rows[0];
      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const data = {};
        headers.forEach((h, j) => data[h] = row[j] || '');

        const docId = data[idField];
        if (!docId) {
          log(`Skipping row ${i + 1}: Missing ${idField}`);
          continue;
        }

        if (await recordExists(collection, docId)) {
          log(`Skipping existing: ${collection}/${docId}`);
        } else {
          await upsertRecord(collection, docId, data);
          log(`Added to ${collection}: ${docId}`);
        }

        if (dualWrite && collection === 'ad_list') {
          const memberId = data.email || data.uid || docId;
          if (memberId) {
            const memberData = {
              uid: memberId,
              email: data.email || '',
              level: data.level || 'FREE',
              origin: 'ads2'
            };
            if (!(await recordExists('members', memberId))) {
              await upsertRecord('members', memberId, memberData);
              log(`Also added to members: ${memberId}`);
            }
          }
        }
      }
    };

    const runPropagation = async () => {
      log("=== STARTING PROPAGATION ===");
      await loadGapi();
      await gapi.auth2.getAuthInstance().signIn();

      const members1 = await getSheet("members1");
      await processSheet(members1, 'members', 'uid');

      const members2 = await getSheet("members2");
      await processSheet(members2, 'members', 'uid');

      const ads1 = await getSheet("ads1");
      await processSheet(ads1, 'ad_list', 'id');

      const ads2 = await getSheet("ads2");
      await processSheet(ads2, 'ad_list', 'id', true);

      log("=== PROPAGATION COMPLETE ===");
    };

    document.getElementById('startBtn').onclick = runPropagation;
  </script>
</body>
</html>
