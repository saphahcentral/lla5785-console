<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Backup Firestore to Google Drive</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    button { font-size: 16px; padding: 10px 15px; cursor: pointer; }
    pre { margin-top: 20px; white-space: pre-wrap; background: #f0f0f0; padding: 15px; height: 300px; overflow-y: scroll; }
  </style>
</head>
<body>

<h2>Backup Firestore Collections to Google Drive</h2>
<button id="backupBtn">Backup Now</button>

<pre id="log">Ready.</pre>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://apis.google.com/js/api.js"></script>

<script>
  const log = document.getElementById('log');
  const backupBtn = document.getElementById('backupBtn');

  const firebaseConfig = {
    apiKey: "AIzaSyA-I0jG1T-sgRBBzTPKvD7hy2Vla8UEnB0",
    authDomain: "lla5785.firebaseapp.com",
    projectId: "lla5785"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const BACKUP_FOLDER_ID = '14OPxw48SpciYLScHc0fgFa9RautBwA15';

  const CLIENT_ID = '324417898140-4ktjksgi2baet3ckol6b0vs5i6vt0k63.apps.googleusercontent.com';
  const API_KEY = 'AIzaSyA-I0jG1T-sgRBBzTPKvD7hy2Vla8UEnB0';
  const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
  const SCOPES = 'https://www.googleapis.com/auth/drive.file';

  function logLine(text) {
    log.textContent += '\n' + text;
  }

  function initClient() {
    return new Promise((resolve, reject) => {
      gapi.load('client:auth2', async () => {
        try {
          await gapi.client.init({
            apiKey: API_KEY,
            clientId: CLIENT_ID,
            discoveryDocs: DISCOVERY_DOCS,
            scope: SCOPES,
          });
          resolve();
        } catch (e) {
          reject(e);
        }
      });
    });
  }

  async function signIn() {
    const authInstance = gapi.auth2.getAuthInstance();
    if (!authInstance.isSignedIn.get()) {
      await authInstance.signIn();
      logLine('Signed in to Google Drive.');
    } else {
      logLine('Already signed in.');
    }
  }

  async function createDriveFolder(folderName, parentId = null) {
    const fileMetadata = {
      'name': folderName,
      'mimeType': 'application/vnd.google-apps.folder',
    };
    if (parentId) fileMetadata.parents = [parentId];

    const response = await gapi.client.drive.files.create({
      resource: fileMetadata,
      fields: 'id'
    });
    return response.result.id;
  }

  async function searchDriveFolder(folderName, parentId = null) {
    let query = `mimeType='application/vnd.google-apps.folder' and name='${folderName}' and trashed=false`;
    if (parentId) query += ` and '${parentId}' in parents`;
    const response = await gapi.client.drive.files.list({
      q: query,
      fields: 'files(id, name)'
    });
    return response.result.files.length ? response.result.files[0].id : null;
  }

  async function uploadFileToDrive(folderId, name, content) {
    const boundary = '-------314159265358979323846';
    const delimiter = "\r\n--" + boundary + "\r\n";
    const close_delim = "\r\n--" + boundary + "--";

    const metadata = {
      'name': name,
      parents: [folderId],
      mimeType: 'application/json'
    };

    const base64Data = btoa(unescape(encodeURIComponent(content)));
    const multipartRequestBody =
      delimiter +
      'Content-Type: application/json\r\n\r\n' +
      JSON.stringify(metadata) +
      delimiter +
      'Content-Type: application/json\r\n' +
      'Content-Transfer-Encoding: base64\r\n' +
      '\r\n' +
      base64Data +
      close_delim;

    const response = await gapi.client.request({
      path: '/upload/drive/v3/files',
      method: 'POST',
      params: { uploadType: 'multipart' },
      headers: { 'Content-Type': 'multipart/related; boundary="' + boundary + '"' },
      body: multipartRequestBody
    });
    return response.result.id;
  }

  <!-- BACKUP COLLECTIONS -->
  async function backupCollections() {
    try {
      await signIn();

      logLine('Using existing Drive backup folder with ID: ' + BACKUP_FOLDER_ID);

      const dateFolderName = new Date().toISOString().split('T')[0];
      let dateFolder = await searchDriveFolder(dateFolderName, BACKUP_FOLDER_ID);
      if (!dateFolder) {
        dateFolder = await createDriveFolder(dateFolderName, BACKUP_FOLDER_ID);
        logLine(`Created dated backup folder: ${dateFolderName}`);
      } else {
        logLine(`Found dated backup folder: ${dateFolderName}`);
      }

      const collections = ['members', 'ad_list'];

      for (const col of collections) {
        logLine(`Backing up collection: ${col} ...`);
        const snapshot = await db.collection(col).get();
        const data = {};
        snapshot.forEach(doc => {
          data[doc.id] = doc.data();
        });
        const filename = `${col}_backup_${dateFolderName}.json`;
        await uploadFileToDrive(dateFolder, filename, JSON.stringify(data, null, 2));
        logLine(`Uploaded ${filename} to Google Drive.`);
      }

      logLine('Backup process complete.');
    } catch (e) {
      logLine('Error during backup: ' + e.message);
    }
  }

  window.onload = () => {
    gapi.load('client:auth2', initClient);
  };

  backupBtn.addEventListener('click', backupCollections);
</script>

</body>
</html>
