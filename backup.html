<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LLA5785 Console - Backup to Google Drive</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #fafafa;
    }
    button {
      padding: 10px 16px;
      font-size: 16px;
      background-color: #007acc;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px 0;
    }
    button:hover {
      background-color: #005fa3;
    }
    pre {
      background: #222;
      color: #0f0;
      padding: 15px;
      height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
      margin-top: 20px;
      border-radius: 4px;
    }
  </style>

  <!-- Firebase and Google API client -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://apis.google.com/js/api.js"></script>

</head>
<body>

<h1>LLA5785 Console - Backup Firestore to Google Drive</h1>

<button id="authorizeBtn">Authorize Google Drive</button>
<button id="backupBtn" disabled>Backup Members & Ads to Drive</button>

<pre id="logConsole">Ready.</pre>

<script>
  // ==== Use your actual OAuth 2.0 credentials here ====
  const CLIENT_ID = '693326104186-00t3vrvt7ogotf65hvljgqcmcg9c5nfq.apps.googleusercontent.com';
  const API_KEY = 'AIzaSyDu3OcghkHbtOH6DnCkoGZyD4qTHUdlA5M';

  const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
  const SCOPES = 'https://www.googleapis.com/auth/drive.file';

  const DRIVE_FOLDER_ID = '1MzeTocaOF6074jEYDTwehsDNQZ-p2UpB';

  const firebaseConfig = {
    apiKey: "AIzaSyDu3OcghkHbtOH6DnCkoGZyD4qTHUdlA5M",
    authDomain: "lla5785.firebaseapp.com",
    projectId: "lla5785",
    storageBucket: "lla5785.appspot.com",
    messagingSenderId: "693326104186",
    appId: "1:693326104186:web:19058ba6f6201092024a5b"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const authorizeBtn = document.getElementById('authorizeBtn');
  const backupBtn = document.getElementById('backupBtn');
  const logConsole = document.getElementById('logConsole');

  function log(text) {
    logConsole.textContent += '\n' + text;
    logConsole.scrollTop = logConsole.scrollHeight;
  }

  // Google API auth2 client
  function handleClientLoad() {
    gapi.load('client:auth2', initClient);
  }

  function initClient() {
    gapi.client.init({
      apiKey: API_KEY,
      clientId: CLIENT_ID,
      discoveryDocs: DISCOVERY_DOCS,
      scope: SCOPES
    }).then(() => {
      gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
      updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
      authorizeBtn.onclick = handleAuthClick;
      backupBtn.onclick = handleBackupClick;
    }, (error) => {
      log('Error loading Google API client: ' + JSON.stringify(error, null, 2));
    });
  }

  function updateSigninStatus(isSignedIn) {
    if (isSignedIn) {
      authorizeBtn.style.display = 'none';
      backupBtn.disabled = false;
      log('âœ… Authorized.');
    } else {
      authorizeBtn.style.display = 'inline-block';
      backupBtn.disabled = true;
      log('âš ï¸ Please authorize access to Google Drive.');
    }
  }

  function handleAuthClick() {
    gapi.auth2.getAuthInstance().signIn();
  }

  async function fetchCollectionData(collectionName) {
    log(`Fetching Firestore collection "${collectionName}"...`);
    const snapshot = await db.collection(collectionName).get();
    const items = [];
    snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
    log(`Fetched ${items.length} records from "${collectionName}".`);
    return items;
  }

  async function uploadFileToDrive(name, content) {
    const boundary = '-------314159265358979323846';
    const delimiter = "\r\n--" + boundary + "\r\n";
    const close_delim = "\r\n--" + boundary + "--";

    const metadata = {
      name: name,
      parents: [DRIVE_FOLDER_ID],
      mimeType: 'application/json'
    };

    const multipartRequestBody =
      delimiter +
      'Content-Type: application/json\r\n\r\n' +
      JSON.stringify(metadata) +
      delimiter +
      'Content-Type: application/json\r\n\r\n' +
      content +
      close_delim;

    return gapi.client.request({
      path: '/upload/drive/v3/files',
      method: 'POST',
      params: { uploadType: 'multipart' },
      headers: { 'Content-Type': 'multipart/related; boundary="' + boundary + '"' },
      body: multipartRequestBody
    });
  }

  async function handleBackupClick() {
    logConsole.textContent = "Starting backup process...\n";

    try {
      const dateStr = new Date().toISOString().slice(0, 10);

      const membersData = await fetchCollectionData('members');
      await uploadFileToDrive(`LLA5785_Backup_members_${dateStr}.json`, JSON.stringify(membersData, null, 2));
      log(`âœ… Uploaded members backup as LLA5785_Backup_members_${dateStr}.json`);

      const adsData = await fetchCollectionData('ad_list');
      await uploadFileToDrive(`LLA5785_Backup_ad_list_${dateStr}.json`, JSON.stringify(adsData, null, 2));
      log(`âœ… Uploaded ad_list backup as LLA5785_Backup_ad_list_${dateStr}.json`);

      log('ðŸŽ‰ Backup completed successfully!');
    } catch (e) {
      log('âŒ Backup error: ' + e.message);
    }
  }

  window.onload = () => {
    handleClientLoad();
  };
</script>

</body>
</html>
