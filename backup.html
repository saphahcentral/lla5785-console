<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LLA5785 Console - Backup to Google Drive</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #fafafa; }
    button { padding: 10px 16px; font-size: 16px; background-color: #007acc; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 5px 0; }
    button:disabled { background:#9fc3ea; cursor:not-allowed; }
    pre { background: #222; color: #0f0; padding: 15px; height: 320px; overflow-y: auto; white-space: pre-wrap; margin-top: 20px; border-radius: 4px; }
    #authStatus { font-weight: bold; margin-bottom: 12px; }
  </style>

  <!-- Firebase (compat) and Google API client -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>

<h1>LLA5785 Console - Backup Firestore to Google Drive</h1>
<div id="authStatus">Checking authentication...</div>

<button id="authorizeBtn" disabled>Authorize Google Drive</button>
<button id="backupBtn" disabled>Backup Members & Ads to Drive</button>

<pre id="logConsole">Ready.</pre>

<script>
  const ADMIN_EMAIL = "bessingerbackup2024@gmail.com";

  // Google Drive OAuth keys (kept same as your original file)
  const CLIENT_ID = '693326104186-00t3vrvt7ogotf65hvljgqcmcg9c5nfq.apps.googleusercontent.com';
  const API_KEY = 'AIzaSyDu3OcghkHbtOH6DnCkoGZyD4qTHUdlA5M';
  const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
  const SCOPES = 'https://www.googleapis.com/auth/drive.file';
  const DRIVE_FOLDER_ID = '1MzeTocaOF6074jEYDTwehsDNQZ-p2UpB';

  const firebaseConfig = {
    apiKey: "AIzaSyBBn8RmuXVvkbbBB0IquYr9S6hXhIgrQCQ",
    authDomain: "lla5785v3-0.firebaseapp.com",
    projectId: "lla5785v3-0",
    storageBucket: "lla5785v3-0.firebasestorage.app",
    messagingSenderId: "730972554331",
    appId: "1:730972554331:web:d97a5fbacebd6aa6e32b7e",
    measurementId: "G-WZNQ24S4DM"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  const authorizeBtn = document.getElementById('authorizeBtn');
  const backupBtn = document.getElementById('backupBtn');
  const logConsole = document.getElementById('logConsole');
  const authStatusEl = document.getElementById('authStatus');

  function log(text) {
    const ts = new Date().toISOString();
    logConsole.textContent += `\n[${ts}] ${text}`;
    logConsole.scrollTop = logConsole.scrollHeight;
    console.log(text);
  }

  log(`Firebase projectId: ${firebase.app().options.projectId}`);

  // Google API client initialization
  function handleClientLoad() {
    try {
      gapi.load('client:auth2', initClient);
    } catch (e) {
      log("gapi.load error: " + e.message);
    }
  }

  function initClient() {
    gapi.client.init({
      apiKey: API_KEY,
      clientId: CLIENT_ID,
      discoveryDocs: DISCOVERY_DOCS,
      scope: SCOPES
    }).then(() => {
      gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
      updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
      authorizeBtn.onclick = handleAuthClick;
      backupBtn.onclick = handleBackupClick;
    }).catch(err => {
      log('Error loading Google API client: ' + JSON.stringify(err, null, 2));
    });
  }

  function updateSigninStatus(isSignedIn) {
    if (isSignedIn) {
      authorizeBtn.style.display = 'none';
      backupBtn.disabled = false;
      log('✅ Google Drive Authorization ready.');
    } else {
      authorizeBtn.style.display = 'inline-block';
      backupBtn.disabled = true;
      log('⚠️ Please authorize access to Google Drive.');
    }
  }

  function handleAuthClick() {
    gapi.auth2.getAuthInstance().signIn();
  }

  async function fetchCollectionData(collectionName) {
    log(`Fetching Firestore collection "${collectionName}"...`);
    const snapshot = await db.collection(collectionName).get();
    const items = [];
    snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
    log(`Fetched ${items.length} records from "${collectionName}".`);
    return items;
  }

  async function uploadFileToDrive(name, content) {
    const boundary = '-------314159265358979323846';
    const delimiter = "\r\n--" + boundary + "\r\n";
    const close_delim = "\r\n--" + boundary + "--";

    const metadata = {
      name: name,
      parents: [DRIVE_FOLDER_ID],
      mimeType: 'application/json'
    };

    const multipartRequestBody =
      delimiter +
      'Content-Type: application/json\r\n\r\n' +
      JSON.stringify(metadata) +
      delimiter +
      'Content-Type: application/json\r\n\r\n' +
      content +
      close_delim;

    return gapi.client.request({
      path: '/upload/drive/v3/files',
      method: 'POST',
      params: { uploadType: 'multipart' },
      headers: { 'Content-Type': 'multipart/related; boundary="' + boundary + '"' },
      body: multipartRequestBody
    });
  }

  async function handleBackupClick() {
    log('Starting backup process...');
    try {
      const dateStr = new Date().toISOString().slice(0, 10);
      const membersData = await fetchCollectionData('members');
      await uploadFileToDrive(`LLA5785V3-0_Backup_members_${dateStr}.json`, JSON.stringify(membersData, null, 2));
      log(`✅ Uploaded members backup as LLA5785V3-0_Backup_members_${dateStr}.json`);

      const adsData = await fetchCollectionData('ad_list');
      await uploadFileToDrive(`LLA5785V3-0_Backup_ad_list_${dateStr}.json`, JSON.stringify(adsData, null, 2));
      log(`✅ Uploaded ad_list backup as LLA5785V3-0_Backup_ad_list_${dateStr}.json`);

      log('🎉 Backup completed successfully!');
    } catch (e) {
      log('❌ Backup error: ' + (e.message || JSON.stringify(e)));
      if (e.result && e.result.error) log('Drive API error: ' + JSON.stringify(e.result.error));
    }
  }

  // Only enable Google Drive actions for admin user
  auth.onAuthStateChanged((user) => {
    log("Auth state changed: " + (user ? (user.email || user.uid) : "signed out"));
    if (user && (user.email || "").toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
      authStatusEl.textContent = `Authenticated as admin: ${user.email}`;
      // Initialize Google API client
      authorizeBtn.disabled = false;
      try {
        handleClientLoad();
      } catch (err) {
        log('gapi init exception: ' + err.message);
      }
    } else {
      authStatusEl.textContent = "Access denied: You are not authenticated as admin.";
      log("Access denied: non-admin or not signed in.");
      authorizeBtn.disabled = true;
      backupBtn.disabled = true;
    }
  });

  window.addEventListener('error', (ev) => {
    log('Window error: ' + ev.message);
  });

  // show projectId for debug
  console.log('Firebase projectId:', firebase.app().options.projectId);
</script>

</body>
</html>
