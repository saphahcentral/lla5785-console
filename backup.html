<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>LLA5785 Console - Backup to Google Drive</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #fafafa; display: flex; }
  .controls { flex: 1; max-width: 400px; margin-right: 20px; }
  button { padding: 10px 16px; font-size: 16px; background-color: #007acc; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 5px 0; width: 100%; }
  button:disabled { background:#9fc3ea; cursor:not-allowed; }
  pre { flex: 2; background: #222; color: #0f0; padding: 15px; height: 600px; overflow-y: auto; white-space: pre-wrap; border-radius: 4px; }
  #authStatus { font-weight: bold; margin-bottom: 12px; }
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>

</head>
<body>

<div class="controls">
  <h1>LLA5785 Console</h1>
  <div id="authStatus">Checking authentication...</div>
  <button id="authorizeBtn" disabled>Authorize Google Drive</button>
  <button id="startBtn" disabled>Start Backup</button>
</div>

<pre id="logConsole">Ready.</pre>

<script>
const ADMIN_EMAIL = "bessingerbackup2024@gmail.com";

// Updated Google Drive OAuth keys
const CLIENT_ID = '730972554331-dq3noaodo7ej74gc3huofdrgbsdispap.apps.googleusercontent.com';
const API_KEY = 'AIzaSyDu3OcghkHbtOH6DnCkoGZyD4qTHUdlA5M';
const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
const SCOPES = 'https://www.googleapis.com/auth/drive.file';
const DRIVE_FOLDER_ID = '1MzeTocaOF6074jEYDTwehsDNQZ-p2UpB';

const firebaseConfig = {
  apiKey: "AIzaSyBBn8RmuXVvkbbBB0IquYr9S6hXhIgrQCQ",
  authDomain: "lla5785v3-0.firebaseapp.com",
  projectId: "lla5785v3-0",
  storageBucket: "lla5785v3-0.firebasestorage.app",
  messagingSenderId: "730972554331",
  appId: "1:730972554331:web:d97a5fbacebd6aa6e32b7e",
  measurementId: "G-WZNQ24S4DM"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

const authorizeBtn = document.getElementById('authorizeBtn');
const startBtn = document.getElementById('startBtn');
const logConsole = document.getElementById('logConsole');
const authStatusEl = document.getElementById('authStatus');

function log(text){
  const ts = new Date().toISOString();
  logConsole.textContent += `\n[${ts}] ${text}`;
  logConsole.scrollTop = logConsole.scrollHeight;
  console.log(text);
}

// --- Google API Client ---
function handleClientLoad(){ gapi.load('client:auth2', initClient); }

function initClient(){
  gapi.client.init({
    apiKey: API_KEY,
    clientId: CLIENT_ID,
    discoveryDocs: DISCOVERY_DOCS,
    scope: SCOPES
  }).then(()=>{
    gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
    updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
    authorizeBtn.onclick = handleAuthClick;
    startBtn.onclick = handleBackupClick;
  }).catch(err=>log('Error loading Google API client: '+JSON.stringify(err)));
}

function updateSigninStatus(isSignedIn){
  if(isSignedIn){
    authorizeBtn.style.display = 'none';
    startBtn.disabled = false;
    log('âœ… Google Drive Authorization ready.');
  } else {
    authorizeBtn.style.display = 'inline-block';
    startBtn.disabled = true;
    log('âš ï¸ Please authorize access to Google Drive.');
  }
}

function handleAuthClick(){ gapi.auth2.getAuthInstance().signIn(); }

// --- Firestore Fetch ---
async function fetchCollectionData(collectionName){
  log(`Fetching Firestore collection "${collectionName}"...`);
  const snapshot = await db.collection(collectionName).get();
  const items = [];
  snapshot.forEach(doc => items.push({id: doc.id, ...doc.data()}));
  log(`Fetched ${items.length} records from "${collectionName}".`);
  return items;
}

// --- Upload to Drive ---
async function uploadFileToDrive(name, content){
  const boundary = '-------314159265358979323846';
  const delimiter = "\r\n--"+boundary+"\r\n";
  const close_delim = "\r\n--"+boundary+"--";

  const metadata = { name:name, parents:[DRIVE_FOLDER_ID], mimeType:'application/json' };
  const multipartRequestBody =
    delimiter+'Content-Type: application/json\r\n\r\n'+JSON.stringify(metadata)+
    delimiter+'Content-Type: application/json\r\n\r\n'+content+
    close_delim;

  return gapi.client.request({
    path:'/upload/drive/v3/files',
    method:'POST',
    params:{uploadType:'multipart'},
    headers:{'Content-Type':'multipart/related; boundary="'+boundary+'"'},
    body: multipartRequestBody
  });
}

// --- Main Backup ---
async function handleBackupClick(){
  log('Starting backup process...');
  try{
    const dateStr = new Date().toISOString().slice(0,10);
    const membersData = await fetchCollectionData('members');
    await uploadFileToDrive(`LLA5785V3-0_Backup_members_${dateStr}.json`, JSON.stringify(membersData,null,2));
    log(`âœ… Uploaded members backup as LLA5785V3-0_Backup_members_${dateStr}.json`);

    const adsData = await fetchCollectionData('ad_list');
    await uploadFileToDrive(`LLA5785V3-0_Backup_ad_list_${dateStr}.json`, JSON.stringify(adsData,null,2));
    log(`âœ… Uploaded ad_list backup as LLA5785V3-0_Backup_ad_list_${dateStr}.json`);

    log('ðŸŽ‰ Backup completed successfully!');
  } catch(e){
    log('âŒ Backup error: '+(e.message||JSON.stringify(e)));
    if(e.result && e.result.error) log('Drive API error: '+JSON.stringify(e.result.error));
  }
}

// --- Firebase Auth Check ---
auth.onAuthStateChanged((user)=>{
  log("Auth state changed: "+(user ? (user.email||user.uid) : "signed out"));
  if(user && (user.email||"").toLowerCase()===ADMIN_EMAIL.toLowerCase()){
    authStatusEl.textContent=`Authenticated as admin: ${user.email}`;
    authorizeBtn.disabled=false;
    handleClientLoad();
  } else {
    authStatusEl.textContent="Access denied: You are not authenticated as admin.";
    log("Access denied: non-admin or not signed in.");
    authorizeBtn.disabled=true;
    startBtn.disabled=true;
  }
});

window.addEventListener('error', ev=>log('Window error: '+ev.message));

</script>

</body>
</html>
